<!DOCTYPE html>
<html lang="km">

<head>
    <meta charset="UTF-8">
    <title>Novel API (WebAssembly/Rust Client)</title>
    <style>
        body {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            font-family: sans-serif;
        }

        .box {
            border: 1px solid #ccc;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }

        #content {
            white-space: pre-wrap;
            line-height: 1.6;
        }

        .status {
            color: #666;
            font-size: 0.9em;
        }

        .error {
            color: red;
        }
    </style>
</head>

<body>
    <h1>소설 뷰어 (Rust Wasm Edition)</h1>
    <div class="box">
        <button onclick="runWasmClient()">소설 불러오기</button>
        <div id="status" class="status">준비됨</div>
        <div id="content"></div>
    </div>

    <!-- WebAssembly Module Loader -->
    <script type="module">
        import init, { CryptoManager } from './pkg/web_wasm.js';

        window.runWasmClient = async function () {
            const statusDiv = document.getElementById('status');
            const contentDiv = document.getElementById('content');

            try {
                statusDiv.innerText = "Wasm 모듈 로딩 중...";
                await init(); // Initialize Wasm

                statusDiv.innerText = "키 생성 중 (Rust)...";
                const cryptoManager = new CryptoManager(); // Rust Object
                const publicKey = cryptoManager.public_key;

                // Auth Signature Generation (in Rust)
                const authJsonCstr = cryptoManager.generate_auth_signature();
                const authData = JSON.parse(authJsonCstr);

                // Network Request
                const novelId = "1"; // Test ID
                statusDiv.innerText = "서버 요청 중...";
                const response = await fetch(`http://localhost:8080/api/novels/${novelId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        publicKey: publicKey,
                        timestamp: authData.timestamp,
                        signature: authData.signature,
                        salt: authData.salt // Generated by Rust
                    })
                });

                if (!response.ok) throw new Error("Network Error");
                const json = await response.json();

                statusDiv.innerText = "복호화 중 (Rust)...";
                // Decrypt Logic (in Rust)
                // Pass novelId for Context Binding Info reconstruction
                const plainText = cryptoManager.decrypt_content(json.publicKey, json.content, novelId);

                contentDiv.innerText = plainText;
                statusDiv.innerText = "완료! (WebAssembly)";

            } catch (e) {
                console.error(e);
                statusDiv.innerText = "오류 발생: " + e;
                statusDiv.className = "status error";
            }
        };
    </script>
</body>

</html>